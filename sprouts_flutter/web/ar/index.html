<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Vanimals AR - Pokemon GO Style</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- 8th Wall A-Frame -->
  <script src="//cdn.8thwall.com/web/aframe/8frame-1.3.0.min.js"></script>
  <script src="//cdn.8thwall.com/web/xrextras/xrextras.js"></script>
  
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    .ui-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 1000;
    }
    
    .top-controls {
      position: fixed;
      top: 20px;
      left: 20px;
      right: 20px;
      display: flex;
      justify-content: space-between;
      pointer-events: auto;
    }
    
    .control-btn {
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 50%;
      cursor: pointer;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    
    .status-indicator {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(138, 43, 226, 0.9);
      color: white;
      padding: 12px 20px;
      border-radius: 20px;
      pointer-events: auto;
      display: none;
    }
    
    .status-indicator.show {
      display: block;
    }
    
    .bottom-controls {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      pointer-events: auto;
    }
    
    .instructions {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(138, 43, 226, 0.95);
      color: white;
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      max-width: 350px;
      z-index: 2000;
      display: none;
    }
    
    .instructions.show {
      display: block;
    }
    
    .start-btn {
      background: white;
      color: #8A2BE2;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <!-- Instructions Overlay -->
  <div id="instructions" class="instructions show">
    <h2>ü¶Å Pokemon GO Style AR</h2>
    <p>Point your camera at a flat surface and tap to place your Vanimal directly in the real world!</p>
    <p><strong>Move around to see it from all angles</strong></p>
    <button class="start-btn" onclick="startAR()">Start AR Experience</button>
  </div>

  <!-- AR Scene -->
  <a-scene
    id="ar-scene"
    xrweb="allowedDevices: any; disableWorldTracking: false"
    xrextras-gesture-detector
    xrextras-loading
    xrextras-runtime-error
    background="color: #000000">
    
    <!-- Assets -->
    <a-assets>
      <!-- Vanimal Models - will be loaded dynamically -->
      <a-asset-item id="pigeon-model" src="../assets/models/pigeon.glb"></a-asset-item>
      <a-asset-item id="elephant-model" src="../assets/models/elephant.glb"></a-asset-item>
      <a-asset-item id="tiger-model" src="../assets/models/tiger.glb"></a-asset-item>
      <a-asset-item id="penguin-model" src="../assets/models/penguin.glb"></a-asset-item>
      <a-asset-item id="axolotl-model" src="../assets/models/axolotl.glb"></a-asset-item>
      <a-asset-item id="chimpanzee-model" src="../assets/models/chimpanzee.glb"></a-asset-item>
    </a-assets>

    <!-- Lights -->
    <a-light type="directional" position="1 1 1" intensity="0.5"></a-light>
    <a-light type="ambient" intensity="0.4"></a-light>

    <!-- Ground Detection Plane (invisible) -->
    <a-plane 
      id="ground-plane"
      position="0 0 -3" 
      rotation="-90 0 0" 
      width="20" 
      height="20" 
      material="opacity: 0; transparent: true"
      visible="false"
      xrextras-tap-recenter>
    </a-plane>

    <!-- Vanimal Entity (will be populated by JavaScript) -->
    <a-entity 
      id="vanimal-container"
      position="0 0 -2"
      visible="false">
    </a-entity>

    <!-- AR Camera -->
    <a-camera 
      id="camera"
      position="0 1.6 0"
      look-controls="enabled: false"
      cursor="rayOrigin: mouse"
      raycaster="objects: #ground-plane, .vanimal">
    </a-camera>
  </a-scene>

  <!-- UI Overlay -->
  <div class="ui-overlay">
    <!-- Top Controls -->
    <div class="top-controls">
      <button class="control-btn" onclick="closeAR()">‚úï</button>
      <div id="status" class="status-indicator">
        üéØ Tap on flat surface to place Vanimal
      </div>
      <button class="control-btn" onclick="toggleInstructions()">?</button>
    </div>

    <!-- Bottom Controls -->
    <div class="bottom-controls">
      <button class="control-btn" onclick="resetAR()" title="Reset">üîÑ</button>
      <button class="control-btn" onclick="takePhoto()" title="Photo">üì∑</button>
      <button class="control-btn" onclick="scaleVanimal()" title="Scale">üîç</button>
      <button class="control-btn" onclick="rotateVanimal()" title="Rotate">‚Üª</button>
    </div>
  </div>

  <script>
    // Global variables
    let currentVanimal = null;
    let vanimalName = 'Cosmic Pigeon';
    let vanimalType = 'pigeon';
    let vanimalScale = 0.3;
    let isARActive = false;

    // Get vanimal info from URL parameters
    function getVanimalFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      vanimalType = urlParams.get('type') || 'pigeon';
      vanimalName = urlParams.get('name') || 'Cosmic Pigeon';
      
      console.log('Vanimal:', vanimalName, vanimalType);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      getVanimalFromURL();
      
      // Set up 8th Wall app key (REPLACE WITH YOUR ACTUAL KEY)
      // You'll get this from your 8th Wall console
      if (window.XR8) {
        XR8.addCameraPipelineModule({
          name: 'vanimals-ar',
          onStart: () => {
            console.log('AR session started');
            showStatus('üéØ Look for flat surfaces and tap to place ' + vanimalName);
            isARActive = true;
          },
          onUpdate: () => {
            // AR tracking update
          }
        });
      }

      // Set up tap-to-place
      setupTapToPlace();
    });

    function startAR() {
      document.getElementById('instructions').classList.remove('show');
      document.getElementById('status').classList.add('show');
      
      // Enable AR tracking
      if (window.XR8) {
        XR8.run();
      }
    }

    function setupTapToPlace() {
      const camera = document.getElementById('camera');
      const scene = document.getElementById('ar-scene');
      
      // Add click listener for tap-to-place
      scene.addEventListener('click', function(event) {
        if (!isARActive) return;
        
        // Get tap position and place vanimal
        placeVanimal(event);
      });
    }

    function placeVanimal(event) {
      const vanimalContainer = document.getElementById('vanimal-container');
      
      // Remove existing vanimal
      if (currentVanimal) {
        vanimalContainer.removeChild(currentVanimal);
      }
      
      // Create new vanimal model
      currentVanimal = document.createElement('a-gltf-model');
      currentVanimal.setAttribute('src', '#' + vanimalType + '-model');
      currentVanimal.setAttribute('scale', vanimalScale + ' ' + vanimalScale + ' ' + vanimalScale);
      currentVanimal.setAttribute('position', '0 0 0');
      currentVanimal.setAttribute('class', 'vanimal');
      
      // Add interactions
      currentVanimal.setAttribute('xrextras-hold-drag', '');
      currentVanimal.setAttribute('xrextras-pinch-scale', 'min: 0.1; max: 2');
      
      // Add shadow
      currentVanimal.setAttribute('shadow', 'receive: false; cast: true');
      
      // Position relative to tap (simplified - in real 8th Wall you'd use hit testing)
      const randomX = (Math.random() - 0.5) * 2;
      const randomZ = (Math.random() - 0.5) * 2;
      vanimalContainer.setAttribute('position', randomX + ' 0 ' + randomZ);
      
      // Add to scene
      vanimalContainer.appendChild(currentVanimal);
      vanimalContainer.setAttribute('visible', 'true');
      
      // Show success message
      showStatus('üéâ ' + vanimalName + ' placed! Move around to see it!');
      
      // Haptic feedback (if supported)
      if (navigator.vibrate) {
        navigator.vibrate(100);
      }
      
      setTimeout(() => {
        showStatus('üëÜ Pinch to scale, drag to move, or use controls below');
      }, 2000);
    }

    function showStatus(message) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.classList.add('show');
      
      setTimeout(() => {
        status.classList.remove('show');
      }, 4000);
    }

    function resetAR() {
      if (currentVanimal) {
        const vanimalContainer = document.getElementById('vanimal-container');
        vanimalContainer.removeChild(currentVanimal);
        vanimalContainer.setAttribute('visible', 'false');
        currentVanimal = null;
        
        showStatus('üîÑ AR scene reset - tap to place ' + vanimalName + ' again');
      }
    }

    function takePhoto() {
      // 8th Wall screenshot functionality
      if (window.XR8 && window.XR8.Threejs) {
        const canvas = document.querySelector('a-scene').canvas;
        const link = document.createElement('a');
        link.download = vanimalName + '_AR_photo.png';
        link.href = canvas.toDataURL();
        link.click();
        
        showStatus('üì∏ AR photo saved!');
      }
    }

    function scaleVanimal() {
      if (currentVanimal) {
        vanimalScale = vanimalScale >= 0.8 ? 0.2 : vanimalScale + 0.2;
        currentVanimal.setAttribute('scale', vanimalScale + ' ' + vanimalScale + ' ' + vanimalScale);
        
        showStatus('üîç ' + vanimalName + ' scaled to ' + Math.round(vanimalScale * 100) + '%');
      }
    }

    function rotateVanimal() {
      if (currentVanimal) {
        const rotation = currentVanimal.getAttribute('rotation');
        const newY = (rotation.y + 45) % 360;
        currentVanimal.setAttribute('rotation', rotation.x + ' ' + newY + ' ' + rotation.z);
        
        showStatus('‚Üª ' + vanimalName + ' rotated');
      }
    }

    function toggleInstructions() {
      const instructions = document.getElementById('instructions');
      instructions.classList.toggle('show');
    }

    function closeAR() {
      // Send message to Flutter to close
      if (window.flutter_inappwebview) {
        window.flutter_inappwebview.callHandler('closeAR');
      } else {
        // Fallback
        window.close();
      }
    }

    // Handle orientation changes
    window.addEventListener('orientationchange', function() {
      setTimeout(() => {
        if (window.XR8) {
          XR8.pause();
          XR8.resume();
        }
      }, 500);
    });
  </script>
</body>
</html>