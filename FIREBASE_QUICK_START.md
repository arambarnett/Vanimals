# Firebase Quick Start for Sprouts

## What We Just Did

✅ Added Firebase packages to Flutter app
✅ Created `FirebaseAuthService` with Google & Apple Sign In
✅ Updated `main.dart` with Firebase initialization
✅ Added social login buttons to UI

---

## Next Steps to Get Firebase Working

### 1. Run FlutterFire CLI (Easiest Method)

```bash
cd sprouts_flutter

# Install FlutterFire CLI
dart pub global activate flutterfire_cli

# Configure Firebase (this will prompt you to select/create project)
flutterfire configure
```

**What this does:**
- Creates Firebase project or connects to existing one
- Generates `firebase_options.dart` with all configuration
- Adds `GoogleService-Info.plist` to iOS
- Adds `google-services.json` to Android
- Configures build files automatically

### 2. Enable Sign-In Methods in Firebase Console

1. Go to: https://console.firebase.google.com/
2. Select your project (or create one named "sprouts-app")
3. Go to **Authentication** → **Sign-in method**
4. Enable **Google** (just toggle it on)
5. Enable **Apple** (toggle on, configure later for production)

### 3. Configure iOS for Apple Sign In (Required for Apple Sign In)

**Prerequisites:** Apple Developer Account ($99/year)

1. Open Xcode: `sprouts_flutter/ios/Runner.xcworkspace`
2. Select **Runner** → **Signing & Capabilities**
3. Add capability: **Sign In with Apple**
4. Go to https://developer.apple.com/account/
5. **Identifiers** → Select your App ID → Enable **Sign In with Apple**

### 4. Test on iPhone

```bash
cd sprouts_flutter
flutter run -d iPhone
```

**Expected flow:**
1. App shows "Sign in with Google" and "Sign in with Apple" buttons
2. Tap Google → Google sign-in sheet appears
3. Sign in → App generates wallet address from Firebase UID
4. Navigate to onboarding/collection screen

---

## Files Created

1. **`lib/data/services/firebase_auth_service.dart`**
   - Production-ready Firebase Auth service
   - Google Sign In implementation
   - Apple Sign In implementation
   - Deterministic wallet address generation from Firebase UID

2. **`lib/firebase_options.dart`**
   - Placeholder for Firebase configuration
   - Will be auto-generated by `flutterfire configure`

3. **`docs/FIREBASE_SETUP.md`**
   - Complete step-by-step Firebase setup guide
   - Apple Developer Portal configuration
   - Troubleshooting tips

---

## How It Works

### Wallet Address Generation

```dart
// Firebase UID → Deterministic Aptos Wallet Address
String firebaseUid = "abc123xyz789...";
String walletAddress = sha256("aptos:$firebaseUid");
// Result: 0x1234567890abcdef...
```

**Benefits:**
- Same Firebase user = Same wallet address (always)
- No private key management in app
- Backend can verify wallet ownership via Firebase ID token

### Authentication Flow

```
User taps "Sign in with Google"
    ↓
Google OAuth (handled by Firebase)
    ↓
Firebase returns User object with UID
    ↓
App generates wallet address from UID
    ↓
App calls backend: POST /api/wallet-auth/connect-wallet
    {
      "walletAddress": "0x123...",
      "socialProvider": "google",
      "socialProviderId": "firebase_uid",
      "name": "John Doe",
      "email": "john@gmail.com"
    }
    ↓
Backend creates user + mints first Sprout NFT
    ↓
Navigate to collection screen
```

---

## Backend Integration (TODO)

The Flutter app now generates wallet addresses, but doesn't call backend yet.

**Next step:** Add backend registration call in `main.dart`:

```dart
Future<void> _registerWithBackend(Map<String, dynamic> authResult) async {
  final response = await http.post(
    Uri.parse('${AppConstants.baseUrl}/api/wallet-auth/connect-wallet'),
    headers: {'Content-Type': 'application/json'},
    body: jsonEncode(authResult),
  );

  if (response.statusCode == 200) {
    final data = jsonDecode(response.body);
    await FirebaseAuthService.setUserId(data['user']['id']);
  }
}
```

---

## Testing Checklist

### Before Running App

- [ ] Run `flutterfire configure` to set up Firebase
- [ ] Enable Google Sign In in Firebase Console
- [ ] Enable Apple Sign In in Firebase Console (optional for testing)
- [ ] Start ngrok for backend: `ngrok http 3000`
- [ ] Start backend: `npm run dev`

### iOS Testing

- [ ] Run `flutter run -d iPhone` (simulator or device)
- [ ] Tap "Sign in with Google"
- [ ] Complete Google sign-in flow
- [ ] Check console for wallet address
- [ ] Verify navigation to onboarding/collection

### Android Testing

- [ ] Run `flutter run -d <android-device>`
- [ ] Test Google Sign In (Apple not available on Android)
- [ ] Verify wallet address generation

---

## Troubleshooting

### Error: "No Firebase App '[DEFAULT]' has been created"

**Fix:** Run `flutterfire configure` to generate `firebase_options.dart`

### Error: "PlatformException (sign_in_failed)"

**Fix:**
1. Check that Google Sign In is enabled in Firebase Console
2. For iOS: Ensure `GoogleService-Info.plist` is in Xcode project
3. For Android: Ensure `google-services.json` is in `android/app/`
4. Add SHA-1 fingerprint to Firebase (Android only)

### Apple Sign In: "Not Available"

**Fix:**
- Apple Sign In only works on iOS 13+ and macOS 10.15+
- Need "Sign In with Apple" capability in Xcode
- Need Apple Developer Account

### Google Sign In: "Developer Error"

**Fix:**
1. Get SHA-1 fingerprint:
   ```bash
   keytool -list -v -keystore ~/.android/debug.keystore -alias androiddebugkey -storepass android -keypass android
   ```
2. Add SHA-1 to Firebase Console:
   - Project Settings → Android App → Add fingerprint

---

## Security Notes

### Don't Commit These Files

Add to `.gitignore`:
```
ios/Runner/GoogleService-Info.plist
android/app/google-services.json
lib/firebase_options.dart
```

### Production Considerations

1. **Firebase Security Rules:** Configure if using Firestore/Storage
2. **App Check:** Enable to prevent abuse
3. **Rate Limiting:** Backend should rate-limit wallet creation
4. **Token Verification:** Backend should verify Firebase ID tokens

---

## Next Steps After Firebase Setup

1. ✅ Test social login on iPhone
2. ⏳ Integrate backend registration call
3. ⏳ Test complete flow: login → backend → NFT mint
4. ⏳ Configure Apple Sign In for production
5. ⏳ Set up Strava OAuth
6. ⏳ Set up Plaid integration

---

## Useful Commands

```bash
# Configure Firebase
flutterfire configure

# Run on iPhone
flutter run -d iPhone

# Run on Android
flutter run -d <device-name>

# Get Firebase project info
firebase projects:list

# View Firebase logs
firebase emulators:start --only auth
```

---

## Support Links

- [FlutterFire Documentation](https://firebase.flutter.dev/)
- [Firebase Console](https://console.firebase.google.com/)
- [Google Sign In Flutter](https://pub.dev/packages/google_sign_in)
- [Sign In with Apple Flutter](https://pub.dev/packages/sign_in_with_apple)
